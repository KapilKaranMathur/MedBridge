generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  role         String?  @default("user")

  appointments   Appointment[]
  medicalRecords MedicalRecord[]
  followUps      FollowUp[]
  Doctor         Doctor?
  Patient        Patient?
}

model Patient {
  id        Int      @id @default(autoincrement())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  age       Int?
  gender    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Doctor {
  id              Int      @id @default(autoincrement())
  name            String
  specialization  String
  city            String
  experienceYears Int
  consultationFee Int
  qualification   String?
  profilePhoto    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  appointments   Appointment[]
  medicalRecords MedicalRecord[]
}

model Appointment {
  id        Int      @id @default(autoincrement())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  doctorId  Int
  doctor    Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  dateTime  DateTime
  status    String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  medicalRecord MedicalRecord?

  @@index([userId])
  @@index([doctorId])
}

model MedicalRecord {
  id            Int         @id @default(autoincrement())
  appointmentId Int         @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  doctorId      Int
  doctor        Doctor      @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patientId     String
  patient       User        @relation(fields: [patientId], references: [id], onDelete: Cascade)
  problem       String
  prescription  String?
  status        String      @default("OPEN")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  followUps FollowUp[]
}

model FollowUp {
  id              Int           @id @default(autoincrement())
  medicalRecordId Int
  medicalRecord   MedicalRecord @relation(fields: [medicalRecordId], references: [id], onDelete: Cascade)
  authorId        String
  author          User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorRole      String
  message         String
  createdAt       DateTime      @default(now())

  @@index([medicalRecordId])
  @@index([authorId])
}
